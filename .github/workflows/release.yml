name: 🚀 Release & Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false
      publish_npm:
        description: "Publish to npm"
        required: false
        type: boolean
        default: true
      publish_jsr:
        description: "Publish to JSR"
        required: false
        type: boolean
        default: true

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_VERSION: "22.11.0"
  PNPM_VERSION: "10.11.0"

jobs:
  # Version validation and setup
  validate:
    name: 🔍 Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      should_publish_npm: ${{ steps.flags.outputs.should_publish_npm }}
      should_publish_jsr: ${{ steps.flags.outputs.should_publish_jsr }}

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🏷️ Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            if [[ "$VERSION" == *"-"* ]]; then
              IS_PRERELEASE=true
            else
              IS_PRERELEASE=false
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (pre-release: $IS_PRERELEASE)"

      - name: 🚩 Set release flags
        id: flags
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_publish_npm=${{ github.event.inputs.publish_npm }}" >> $GITHUB_OUTPUT
            echo "should_publish_jsr=${{ github.event.inputs.publish_jsr }}" >> $GITHUB_OUTPUT
          else
            echo "should_publish_npm=true" >> $GITHUB_OUTPUT
            echo "should_publish_jsr=true" >> $GITHUB_OUTPUT
          fi

      - name: 📋 Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: x.y.z or x.y.z-suffix"
            exit 1
          fi
          echo "✅ Version format is valid: $VERSION"

  # Build and test everything ONCE
  build:
    name: 🏗️ Build & Test All
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 25

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🦀 Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 📦 Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: 🧪 Run full test suite
        run: |
          # Rust tests
          cargo test --workspace --verbose --locked

          # Build WASM (リリース最適化)
          wasm-pack build packages/crates/gnrng-id --target web --scope nap5 --release

          # Install Node.js dependencies
          pnpm install --frozen-lockfile --shamefully-hoist

          # Build packages
          pnpm --filter @internal/utils build
          pnpm --filter @nap5/gnrng-id build:lib

          # TypeScript tests
          pnpm --filter @internal/utils test:run
          pnpm --filter @nap5/gnrng-id test:run
          pnpm --filter app test:run

          # Benchmarks
          pnpm --filter @nap5/gnrng-id benchmark

      - name: 🏗️ Build demo app
        run: pnpm --filter app build

      - name: 📦 Package build artifacts for publishing
        run: |
          # 必要なファイルのみを整理してパッケージング
          mkdir -p build-artifacts

          # WASM artifacts (packages/crates/gnrng-id/pkg/)
          mkdir -p build-artifacts/wasm-pkg
          cp -r packages/crates/gnrng-id/pkg/* build-artifacts/wasm-pkg/

          # TypeScript build artifacts (packages/lib/dist/)
          mkdir -p build-artifacts/lib-dist  
          cp -r packages/lib/dist/* build-artifacts/lib-dist/

          # Source files for JSR (packages/lib/src/)
          mkdir -p build-artifacts/lib-src
          cp -r packages/lib/src/* build-artifacts/lib-src/

          # Config files
          cp packages/lib/package.json build-artifacts/package.json
          cp packages/lib/jsr.json build-artifacts/jsr.json
          cp packages/lib/README.md build-artifacts/README.md
          cp packages/lib/LICENSE build-artifacts/LICENSE

          # Verification
          echo "📋 Build artifacts contents:"
          find build-artifacts -type f | head -20

          echo "📋 WASM pkg contents:"
          ls -la build-artifacts/wasm-pkg/

          echo "📋 TypeScript dist contents:"
          ls -la build-artifacts/lib-dist/

      - name: 📤 Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/
          retention-days: 1

  # Publish to npm
  publish-npm:
    name: 📦 Publish to npm
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.validate.outputs.should_publish_npm == 'true'
    environment: npm-publish
    timeout-minutes: 10

    steps:
      - name: 📥 Checkout (for structure)
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"

      - name: 📥 Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/

      - name: 📦 Restore package structure for npm
        run: |
          # lib ディレクトリ構造を再構築
          mkdir -p packages/lib/dist
          mkdir -p packages/crates/gnrng-id/pkg

          # Build artifacts を正しい場所に配置
          cp -r build-artifacts/lib-dist/* packages/lib/dist/
          cp -r build-artifacts/wasm-pkg/* packages/crates/gnrng-id/pkg/
          cp build-artifacts/package.json packages/lib/package.json
          cp build-artifacts/README.md packages/lib/README.md
          cp build-artifacts/LICENSE packages/lib/LICENSE

          # Verification
          echo "📋 Restored structure:"
          ls -la packages/lib/
          ls -la packages/lib/dist/
          ls -la packages/crates/gnrng-id/pkg/

      - name: 📦 Update package version and resolve workspace dependencies
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cd packages/lib

          echo "📋 Original package.json:"
          cat package.json | jq '.'

          # Update package version using jq
          echo "Updating package.json version to $VERSION..."
          jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json

          # Resolve workspace dependencies for npm publishing
          echo "Resolving workspace dependencies..."
          # Replace workspace:* dependencies with actual file paths or remove them
          # for npm publishing, we need to handle workspace dependencies differently

          # Method 1: Remove workspace dependencies entirely (if they're dev dependencies)
          jq 'del(.dependencies["@nap5/gnrng-id-wasm"]) | del(.devDependencies["@internal/utils"]) | del(.devDependencies["@internal/shared-config"])' package.json > package.json.tmp
          mv package.json.tmp package.json

          # Verify the final package.json
          echo "📋 Final package.json for npm:"
          cat package.json | jq '.'

          echo "✅ Updated package.json version:"
          jq -r '.version' package.json

      - name: 🔍 Verify package contents for npm
        run: |
          cd packages/lib
          echo "📋 Final package contents:"
          ls -la
          echo "📋 Dist contents:"
          ls -la dist/
          echo "📋 Package.json version:"
          node -p "require('./package.json').version"

          # npm pack のドライラン
          npm pack --dry-run

      - name: 🚀 Publish to npm
        run: |
          cd packages/lib
          if [ "${{ needs.validate.outputs.is_prerelease }}" = "true" ]; then
            # prepublishOnlyをスキップしてpublish（CI環境では既にビルド・テスト済み）
            npm publish --access public --tag beta --ignore-scripts
            echo "✅ Published pre-release to npm with 'beta' tag"
          else
            npm publish --access public --ignore-scripts
            echo "✅ Published stable release to npm"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Publish to JSR
  publish-jsr:
    name: 🦕 Publish to JSR
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.validate.outputs.should_publish_jsr == 'true'
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write

    steps:
      - name: 📥 Checkout (for structure)
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 📥 Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/

      - name: 📦 Restore package structure for JSR
        run: |
          # lib ディレクトリ構造を再構築（JSRはソースが必要）
          mkdir -p packages/lib/src
          mkdir -p packages/crates/gnrng-id/pkg

          # Build artifacts を正しい場所に配置
          cp -r build-artifacts/lib-src/* packages/lib/src/
          cp -r build-artifacts/wasm-pkg/* packages/crates/gnrng-id/pkg/
          cp build-artifacts/jsr.json packages/lib/jsr.json
          cp build-artifacts/README.md packages/lib/README.md
          cp build-artifacts/LICENSE packages/lib/LICENSE

          # Verification
          echo "📋 Restored structure for JSR:"
          ls -la packages/lib/
          ls -la packages/lib/src/
          ls -la packages/crates/gnrng-id/pkg/

      - name: 📦 Update JSR version and clean config
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cd packages/lib

          echo "📋 Original jsr.json:"
          cat jsr.json | jq '.'

          # Update JSR version using jq
          echo "Updating jsr.json version to $VERSION..."
          jq --arg version "$VERSION" '.version = $version' jsr.json > jsr.json.tmp
          mv jsr.json.tmp jsr.json

          # Remove unstable field if it exists (JSR workspace issue)
          echo "Cleaning JSR config..."
          jq 'del(.unstable)' jsr.json > jsr.json.tmp
          mv jsr.json.tmp jsr.json

          # Remove any workspace-specific fields that might cause issues
          jq 'del(.permissions.ffi) | del(.permissions.env) | del(.permissions.read) | del(.permissions.write) | del(.permissions.run) | del(.permissions.net)' jsr.json > jsr.json.tmp
          mv jsr.json.tmp jsr.json

          # Set minimal permissions for JSR
          jq '.permissions = {}' jsr.json > jsr.json.tmp
          mv jsr.json.tmp jsr.json

          # Verify the final jsr.json
          echo "📋 Final jsr.json:"
          cat jsr.json | jq '.'

          echo "✅ Updated jsr.json version:"
          jq -r '.version' jsr.json

      - name: 🔍 Verify JSR config
        run: |
          cd packages/lib
          echo "📋 JSR config:"
          cat jsr.json
          echo "📋 JSR version:"
          node -p "JSON.parse(require('fs').readFileSync('jsr.json', 'utf8')).version"

          # JSR publish のドライラン
          npx jsr publish --dry-run

      - name: 🚀 Publish to JSR (OIDC)
        run: |
          cd packages/lib
          npx jsr publish
          echo "✅ Published to JSR using OIDC authentication"

  # GitHub Release
  github-release:
    name: 📝 Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build, publish-npm, publish-jsr]
    if: always() && needs.build.result == 'success'
    permissions:
      contents: write
    timeout-minutes: 10

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📥 Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/

      - name: 📝 Generate changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "## 🚀 Changes since $PREV_TAG" > changelog.md
            echo "" >> changelog.md
            git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges >> changelog.md
          else
            echo "## 🚀 Initial Release" > changelog.md
            echo "" >> changelog.md
            echo "First release of @nap5/gnrng-id!" >> changelog.md
          fi

          echo "" >> changelog.md
          echo "## 📦 Installation" >> changelog.md
          echo "- **npm**: \`npm install @nap5/gnrng-id@$VERSION\`" >> changelog.md
          echo "- **JSR**: \`deno add @nap5/gnrng-id@$VERSION\`" >> changelog.md

      - name: 📝 Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: Release v${{ needs.validate.outputs.version }}
          body_path: changelog.md
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: |
            build-artifacts/lib-dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Docker release
  docker-release:
    name: 🐳 Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [validate, build]
    permissions:
      contents: read
      packages: write
    timeout-minutes: 20

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🐳 Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔐 Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 🏷️ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=v${{ needs.validate.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: 🏗️ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # Release summary
  release-summary:
    name: ✅ Release Summary
    if: always()
    runs-on: ubuntu-latest
    needs:
      [
        validate,
        build,
        publish-npm,
        publish-jsr,
        github-release,
        docker-release,
      ]

    steps:
      - name: 📊 Summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "## 🚀 Release Summary: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### 📦 Publishing Status" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.publish-npm.result }}" = "success" ]; then
            echo "| npm | ✅ Published | [View](https://www.npmjs.com/package/@nap5/gnrng-id) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate.outputs.should_publish_npm }}" = "true" ]; then
            echo "| npm | ❌ Failed | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| npm | ⏭️ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.publish-jsr.result }}" = "success" ]; then
            echo "| JSR | ✅ Published | [View](https://jsr.io/@nap5/gnrng-id) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate.outputs.should_publish_jsr }}" = "true" ]; then
            echo "| JSR | ❌ Failed | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| JSR | ⏭️ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.github-release.result }}" = "success" ]; then
            echo "| GitHub | ✅ Created | [View](https://github.com/${{ github.repository }}/releases/tag/v$VERSION) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GitHub | ❌ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docker-release.result }}" = "success" ]; then
            echo "| Docker | ✅ Published | [View](https://ghcr.io/${{ github.repository }}) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker | ❌ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
